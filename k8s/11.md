# Lab 11

## Manual secret management

Create via `minikube kubectl -- create secret generic sample-secret --from-literal=secret_key=haha`

Get json via `minikube kubectl -- get secret sample-secret -o json`:

```json
{
    "apiVersion": "v1",
    "data": {
        "secret_key": "aGFoYQ=="
    },
    "kind": "Secret",
    "metadata": {
        "creationTimestamp": "2024-04-16T21:04:38Z",
        "name": "sample-secret",
        "namespace": "default",
        "resourceVersion": "8209",
        "uid": "170667c7-d8f5-4787-a3df-eb354761f318"
    },
    "type": "Opaque"
}
```

And then decode via `echo "aGFoYQ==" | base64 --decode`


Install plugin via `helm plugin install https://github.com/jkroepke/helm-secrets --version v4.6.0`


## Helm secret management

Create secrets file via `sops -p 42E81B348BEF0739D66B0293F60DF0A27D099355 k8s/web-app/secrets.yaml`

Decrypt to verify it `helm secrets decrypt k8s/web-app/secrets.yaml`:

```shell
password: secret1234
```

Install via `helm secrets install web-app ./k8s/web-app/ -n default -f ./k8s/web-app/secrets.yaml`:

```shell
[helm-secrets] Decrypt: ./k8s/web-app/secrets.yaml
NAME: web-app
LAST DEPLOYED: Wed Apr 17 00:39:22 2024
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=web-app,app.kubernetes.io/instance=web-app" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT

[helm-secrets] Removed: ./k8s/web-app/secrets.yaml.dec
```


To verify that it works, get yaml via `minikube kubectl -- get secret credentials -o yaml`:

```yaml
apiVersion: v1
data:
  password: c2VjcmV0MTIzNA==
kind: Secret
metadata:
  annotations:
    meta.helm.sh/release-name: web-app
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2024-04-16T21:39:27Z"
  labels:
    app: app
    app.kubernetes.io/managed-by: Helm
    chart: web-app-0.1.0
    heritage: Helm
    release: web-app
  name: credentials
  namespace: default
  resourceVersion: "10196"
  uid: d577b0f3-e8b1-4f17-8cf9-1413b3c6e86a
type: Opaque
```

And decrypt it via `echo "c2VjcmV0MTIzNA==" | base64 --decode`

See list of services via `minikube kubectl get po`:

```shell
NAME                      READY   STATUS    RESTARTS   AGE
web-app-88c6db6c7-tw6jd   1/1     Running   0          3m43s
```

Verify the presence of variable via `minikube kubectl exec web-app-88c6db6c7-tw6jd -- printenv | grep MY_PASSWORD`:

```shell
MY_PASSWORD=secret1234
```

## Vault secret management

Follow tutorial from here: https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-sidecar#define-a-kubernetes-service-account

Note that the patching is done via ` minikube kubectl -- patch deployment web-app --patch "$(cat ./k8s/web-app/patch-inject-secrets-as-template.yaml)"`

Then I do `minikube kubectl -- exec -it web-app-6f8d49dfbf-btmvg -- sh` and `cat /vault/secrets/database-config.txt`:

```shell
postgresql://db-readonly-username:db-secret-password@postgres:5432
```